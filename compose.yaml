########################### NETWORKS
networks:
  mediaserver:
    driver: bridge
    name: mediaserver
    external: true

services:
########################### REVERSE PROXY / NETWORKING / SECURITY    
  # Traefik 3 - Reverse Proxy
  traefik:
    image: traefik:v3
    container_name: traefik
    restart: always
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    security_opt:
      - no-new-privileges:true
    networks:
      mediaserver:
    ports:
      - 89:80
      - 449:443
      - 127.0.0.1:8080:8080 # http api dashboard
    command: # CLI arguments
      # Dashboard, Ping, Telemetry
      - --global.sendAnonymousUsage=true
      - --global.checknewversion=true
      - --api.dashboard=true
      - --api.insecure=false
      - --ping=true
      # Providers, Entrypoints
      - --providers.docker=true
      # - --providers.docker.endpoint=tcp://socket:2375 # Enable for Socket Proxy. Disable otherwise.
      - --providers.docker.exposedByDefault=true
      - --providers.docker.network=mediaserver
      - --providers.docker.endpoint=unix:///var/run/docker.sock # Disable for Socket Proxy. Enable otherwise.
      - --providers.file.directory=/rules # Load dynamic configuration from one or more .toml or .yml files in a directory
      - --providers.file.watch=true # Only works on top level files in the rules folder
      - --entrypoints.http.address=:80
      - --entrypoints.https.address=:443
      # Redirect to https
      - --entrypoints.http.forwardedHeaders.trustedIPs=$TRUSTED_IPS
      - --entrypoints.http.http.redirections.entrypoint.to=https
      - --entrypoints.http.http.redirections.entrypoint.scheme=https
      - --entrypoints.http.http.redirections.entrypoint.permanent=true
      # Logging
      - --entryPoints.http.observability.accessLogs=true
      - --accesslog.filepath=/logs/access.log
      - --accesslog.format=json
      - --accesslog.bufferingsize=0
      - --accesslog.filters.statuscodes=400-599 # only log http errors in logs; alternatively set 200-599 to include successful http requests
      - --accesslog.fields.headers.defaultmode=drop # drop all headers
      - --accesslog.fields.headers.names.user-agent=keep # keep user-agent header
      - --metrics.prometheus=true
      # TLS
      - --serversTransport.insecureSkipVerify=false # set insecureSkipVerify to true to allow self-signed certificates
      - --entrypoints.https.http.tls=true
      - --certificatesresolvers.cloudflare.acme.tlschallenge=true # disable this and enable below to avoid rate-limiting
      # - --certificatesresolvers.cloudflare.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
      - --entrypoints.https.http.tls.certresolver=cloudflare
      - --entrypoints.https.http.tls.domains[0].main=$DOMAINNAME
      - --entrypoints.https.http.tls.domains[0].sans=*.$DOMAINNAME
      - --certificatesresolvers.cloudflare.acme.email=$CF_EMAIL
      - --certificatesresolvers.cloudflare.acme.storage=/certs/acme.json
      - --certificatesResolvers.cloudflare.acme.dnsChallenge.provider=cloudflare
      - --certificatesResolvers.cloudflare.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
      - --certificatesResolvers.cloudflare.acme.dnsChallenge.propagation.delayBeforeChecks=90
      # Plugins
      # - --experimental.plugins.bouncer.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
      # - --experimental.plugins.bouncer.version=v1.4.6
    volumes:
      - $APPDIR/traefik:/etc/traefik
      - $APPDIR/traefik/rules:/rules
      - $APPDIR/traefik/logs:/logs
      - $DOCKERDIR/certs:/certs
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=$TZ
      - CF_API_EMAIL=$CF_EMAIL
      - CF_API_KEY=$CF_API_KEY
      - DOMAINNAME # Passing the domain name to use the variable in rules.
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers - Dashboard
      - traefik.http.routers.dashboard.entrypoints=https
      - traefik.http.routers.dashboard.rule=Host(`traefik.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.dashboard.middlewares=auth
      # Services - API
      - traefik.http.routers.dashboard.service=api@internal
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # OAuth - Single Sign On using OAuth 2.0
  auth:
    image: ghcr.io/italypaleale/traefik-forward-auth:4
    container_name: auth
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/traefik-forward-auth", "healthcheck"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      mediaserver:
    ports:
      - 4181:4181
    volumes:
      - $APPDIR/auth:/etc/traefik-forward-auth
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.auth.entrypoints=https
      - traefik.http.routers.auth.rule=Host(`auth.$DOMAINNAME`)
      # Middlewares
      - traefik.http.middlewares.auth.forwardauth.address=http://auth:4181/portals/main
      - traefik.http.middlewares.auth.forwardauth.authResponseHeaders=X-Forwarded-User,X-Forwarded-Displayname,X-Authenticated-User
      - traefik.http.middlewares.auth.forwardauth.trustForwardHeader=true
      # HTTP Services
      - traefik.http.services.auth.loadbalancer.server.port=4181
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # Certdumper - Export acme.json
  certdumper:
    image: ghcr.io/kereis/traefik-certs-dumper:latest
    container_name: certdump
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/bin/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      mediaserver:
    volumes:
      - $DOCKERDIR/certs:/traefik:ro
      - $DOCKERDIR/certexports:/output:rw
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - traefik.enable=false

  # Gluetun - VPN for torrents
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=1
    networks:
      mediaserver:
    ports:
      - 8000:8000/tcp # gluetun control server
      - 9997:9997 # qBit WebUI
      - 51007:51007 # qBit listening port
    volumes:
      - $APPDIR/gluetun:/config
      - $APPDIR/gluetun/auth/config.toml:/config/auth/config.toml
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - STORAGE_FILEPATH=/config/servers.json
      - VPN_SERVICE_PROVIDER=airvpn
      - VPN_TYPE=wireguard
      - DNS_SERVER=off
      - DNS_UPSTREAM_RESOLVER_TYPE=dot # dot for tls, doh for http
      - DNS_UPSTREAM_RESOLVERS=cloudflare
      - WIREGUARD_PRIVATE_KEY=$WIREGUARD_PRIVATE_KEY
      - WIREGUARD_PRESHARED_KEY=$WIREGUARD_PRESHARED_KEY
      - WIREGUARD_ADDRESSES=$WIREGUARD_ADDRESSES
      - WIREGUARD_PERSISTENT_KEEPALIVE_INTERVAL=60s
      - SERVER_COUNTRIES=Netherlands
      - UPDATER_PERIOD=0 #DNS Update was causing qbit to lose connection
      - FIREWALL_VPN_INPUT_PORTS=51007
      - BLOCK_MALICIOUS=no
      - HTTP_CONTROL_SERVER_AUTH_CONFIG_FILEPATH=/config/auth/config.toml
      - LOG_LEVEL=info
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ############################# HOMEPAGE
  # Organizr - A dashboard for your server
  organizr:
    image: ghcr.io/organizr/organizr:latest
    container_name: organizr
    restart: unless-stopped
    networks:
      mediaserver:
    ports:
      - 9999:80
    volumes:
      - $APPDIR/organizr:/config
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.organizr.entrypoints=https
      - traefik.http.routers.organizr.rule=Host(`$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.organizr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.organizr.service=organizr
      - traefik.http.services.organizr.loadbalancer.server.port=80
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# INDEXERS
  # Prowlarr - Hydra and Jackett combined
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9696/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      mediaserver:
    ports:
      - 9696:9696
    volumes:
      - $APPDIR/prowlarr:/config:rw
      - $DATADIR/torrents:/data/torrents:rw
      - $DATADIR/usenet:/data/usenet:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 1024M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.prowlarr.entrypoints=https
      - traefik.http.routers.prowlarr.rule=Host(`prowlarr.$DOMAINNAME`)
      # HTTP Routers Auth Bypass (for NZB360)
      - traefik.http.routers.prowlarr-bypass.entrypoints=https
      - traefik.http.routers.prowlarr-bypass.rule=Host(`prowlarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$PROWLARR_API_KEY`) || Query(`apikey`, `$PROWLARR_API_KEY`))
      - traefik.http.routers.prowlarr-bypass.priority=100
      # Middlewares
      - traefik.http.routers.prowlarr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.prowlarr.service=prowlarr
      - traefik.http.routers.prowlarr-bypass.service=prowlarr
      - traefik.http.services.prowlarr.loadbalancer.server.port=9696
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# DOWNLOADERS
  # SABnzbd - nzb downloader
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    restart: unless-stopped
    networks:
      mediaserver:
    ports:
      - 9998:8080
    volumes:
      - $APPDIR/sabnzbd:/config
      - $DATADIR/usenet:/data/usenet:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - HAS_IPV6=false
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.sabnzbd.entrypoints=https
      - traefik.http.routers.sabnzbd.rule=Host(`sabnzbd.$DOMAINNAME`)
      # HTTP Routers Auth Bypass
      - traefik.http.routers.sabnzbd-bypass.entrypoints=https
      - traefik.http.routers.sabnzbd-bypass.rule=Host(`sabnzbd.$DOMAINNAME`) && (Header(`X-Api-Key`, `$SABNZBD_API_KEY`) || Query(`apikey`, `$SABNZBD_API_KEY`))
      - traefik.http.routers.sabnzbd-bypass.priority=100
      # Middlewares
      - traefik.http.routers.sabnzbd.middlewares=auth
      # HTTP Services
      - traefik.http.routers.sabnzbd.service=sabnzbd
      - traefik.http.routers.sabnzbd-bypass.service=sabnzbd
      - traefik.http.services.sabnzbd.loadbalancer.server.port=8080
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # qbittorrent - LSIO container, using Gluetun for VPN
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: "service:gluetun"
    volumes:
      - $APPDIR/qbittorrent:/config:rw
      - $DATADIR/torrents:/data/torrents:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - WEBUI_PORT=9997
      - TORRENTING_PORT=51007
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.qbittorrent.entrypoints=https
      - traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.qbittorrent.middlewares=auth
      # HTTP Services
      - traefik.http.routers.qbittorrent.service=qbittorrent
      - traefik.http.services.qbittorrent.loadbalancer.server.port=9997
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # qbit_restart - torrent client restart when gluetun fails
  restart-qbittorrent:
    image: jakub95/restart-qbittorrent:latest
    container_name: restart-qbittorrent
    restart: unless-stopped
    network_mode: none
    environment:
      - TZ=$TZ
      - QBITTORRENT_CONTAINER_NAME=qbittorrent
      - GLUETUN_CONTAINER_NAME=gluetun
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=false
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # qbit_manage - torrent client management
  qbit_manage:
    image: bobokun/qbit_manage
    container_name: qbitmanage
    restart: unless-stopped
    networks:
      mediaserver:
    volumes:
      - $APPDIR/qbitmanage:/config:rw
      - $APPDIR/qbittorrent/:/qbittorrent/:ro
      - $DATADIR/torrents:/data/torrents:rw # same as qbittorrent download dir
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - QBT_WEB_SERVER=true
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.qbitmanage.entrypoints=https
      - traefik.http.routers.qbitmanage.rule=Host(`qbitmanage.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.qbitmanage.middlewares=auth
      # HTTP Services
      - traefik.http.routers.qbitmanage.service=qbitmanage
      - traefik.http.services.qbitmanage.loadbalancer.server.port=8080
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # autobrr - torrent RSS downloader
  autobrr:
    image: ghcr.io/autobrr/autobrr:latest
    container_name: autobrr
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -X GET 'http://127.0.0.1:7474/api/healthz/readiness' -H 'X-API-Token: $AUTOBRR_API_KEY' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      mediaserver:
    ports:
      - 7474:7474
    user: $PUID:$PGID
    volumes:
      - $APPDIR/autobrr:/config
      - $APPDIR/autobrr/logs:/logs
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.autobrr.entrypoints=https
      - traefik.http.routers.autobrr.rule=Host(`autobrr.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.autobrr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.autobrr.service=autobrr
      - traefik.http.services.autobrr.loadbalancer.server.port=7474
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# MEDIA SEARCH/INDEX
  # Radarr - Movies
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7878/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      mediaserver:
    ports:
      - 7878:7878
    depends_on:
      prowlarr:
        condition: service_healthy
    volumes:
      - $APPDIR/radarr:/config
      - $DATADIR:/data
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.radarr.entrypoints=https
      - traefik.http.routers.radarr.rule=Host(`radarr.$DOMAINNAME`)
      # HTTP Routers Auth Bypass
      - traefik.http.routers.radarr-bypass.entrypoints=https
      - traefik.http.routers.radarr-bypass.rule=Host(`radarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$RADARR_API_KEY`) || Query(`apikey`, `$RADARR_API_KEY`))
      - traefik.http.routers.radarr-bypass.priority=100
      # Middlewares
      - traefik.http.routers.radarr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.radarr.service=radarr
      - traefik.http.routers.radarr-bypass.service=radarr
      - traefik.http.services.radarr.loadbalancer.server.port=7878
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # Sonarr - TV
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8989/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      mediaserver:
    ports:
      - 8989:8989
    depends_on:
      prowlarr:
        condition: service_healthy
    volumes:
      - $APPDIR/sonarr:/config
      - $DATADIR:/data
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.sonarr.entrypoints=https
      - traefik.http.routers.sonarr.rule=Host(`sonarr.$DOMAINNAME`)
      # HTTP Routers Auth Bypass
      - traefik.http.routers.sonarr-bypass.entrypoints=https
      - traefik.http.routers.sonarr-bypass.rule=Host(`sonarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$SONARR_API_KEY`) || Query(`apikey`, `$SONARR_API_KEY`))
      - traefik.http.routers.sonarr-bypass.priority=100
      # Middlewares
      - traefik.http.routers.sonarr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.sonarr.service=sonarr
      - traefik.http.routers.sonarr-bypass.service=sonarr
      - traefik.http.services.sonarr.loadbalancer.server.port=8989
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# HOME THEATRE
  # Plex - Media Player
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:32400/web/index.html || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      mediaserver:
    ports:
      - 32400:32400/tcp
      - 8324:8324/tcp
      - 32469:32469/tcp
      - 1900:1900/udp
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
    devices: # optional (used if Syno has Intel CPU, for HW transcoding)
      - /dev/dri:/dev/dri
    volumes:
      - $APPDIR/plex:/config:rw
      - $DATADIR/media:/data/media:rw
      - $DATADIR/media/tv:/tv:rw
      - $DATADIR/media/movies:/movies:rw
      - $DATADIR/media/temp/plex:/temp:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - VERSION=docker
    deploy:
      resources:
        limits:
          memory: 1536M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.plex.entrypoints=https
      - traefik.http.routers.plex.rule=Host(`plex.$DOMAINNAME`)
      # HTTP Services
      - traefik.http.routers.plex.service=plex
      - traefik.http.services.plex.loadbalancer.server.port=32400
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# MEDIA FILE MANAGEMENT
  # Tdarr - Transcode for compatibility with Plex streaming
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    restart: unless-stopped
    networks:
      mediaserver:
    ports:
      - 8265:8265 # webUI port
      - 8266:8266 # server port
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - $APPDIR/tdarr/server:/app/server
      - $APPDIR/tdarr/configs:/app/configs
      - $APPDIR/tdarr/logs:/app/logs
      - $APPDIR/tdarr/temp:/temp:rw
      - $DATADIR/media:/data/media:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - UMASK_SET=002
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - ffmpegVersion=7
      - nodeName=TdarrNode
      - auth=false
      - openBrowser=false
      - maxLogSizeMB=4
      - cronPluginUpdate=
    deploy:
      resources:
        limits:
          memory: 768M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.tdarr.entrypoints=https
      - traefik.http.routers.tdarr.rule=Host(`tdarr.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.tdarr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.tdarr.service=tdarr
      - traefik.http.services.tdarr.loadbalancer.server.port=8265
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# PLEX MONITORING/MANAGEMENT
  # Tautulli - Media play and user monitoring
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8181/status || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      plex:
        condition: service_healthy
    networks:
      mediaserver:
    ports:
      - 8181:8181
    volumes:
      - $APPDIR/tautulli:/config:rw
      - $PLEXLOGS:/plexlogs:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.tautulli.entrypoints=https
      - traefik.http.routers.tautulli.rule=Host(`tautulli.$DOMAINNAME`)
      # HTTP Routers Auth Bypass
      - traefik.http.routers.tautulli-bypass.entrypoints=https
      - traefik.http.routers.tautulli-bypass.rule=Host(`tautulli.$DOMAINNAME`) && (Header(`X-Api-Key`, `$TAUTULLI_API_KEY`) || Query(`apikey`, `$TAUTULLI_API_KEY`))
      # Middlewares
      - traefik.http.routers.tautulli.middlewares=auth
      # HTTP Services
      - traefik.http.routers.tautulli.service=tautulli
      - traefik.http.routers.tautulli-bypass.service=tautulli
      - traefik.http.services.tautulli.loadbalancer.server.port=8181
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # Seer - Allows Plex users to request media
  jellyseerr:
    image: fallenbagel/jellyseerr
    container_name: jellyseerr
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      mediaserver:
    ports:
      - 5055:5055
    depends_on:
      plex:
        condition: service_healthy
    volumes:
      - $APPDIR/jellyseerr:/app/config
      - $APPDIR/jellyseerr/cache:/app/config/cache/images
      - $DATADIR/media:/data/media
    environment:
      - TZ=$TZ
      - LOG_LEVEL=error
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.overseerr.entrypoints=https
      - traefik.http.routers.overseerr.rule=Host(`overseerr.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.overseerr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.overseerr.service=overseerr
      - traefik.http.services.overseerr.loadbalancer.server.port=5055
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # Maintainerr - Scrub requested but unwatched media
  maintainerr:
    image: jorenn92/maintainerr:latest
    container_name: maintainerr
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6246/api/app/status || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    user: $PUID:$PGID
    networks:
      mediaserver:
    ports:
      - 6246:6246
    volumes:
      - $APPDIR/maintainerr:/opt/data
    environment:
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.maintainerr.entrypoints=https
      - traefik.http.routers.maintainerr.rule=Host(`maintainerr.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.maintainerr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.maintainerr.service=maintainerr
      - traefik.http.services.maintainerr.loadbalancer.server.port=6246
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# BOOK LIBRARY MANAGEMENT
  # Calibre Web Automated - fork of Calibre-web, includes auto conversion
  calibreweb:
    image: crocodilestick/calibre-web-automated:latest
    container_name: books
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 8083 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s
    networks:
      mediaserver:
    volumes:
      - $APPDIR/books:/config
      - $DATADIR/imports:/cwa-book-ingest
      - $DATADIR/media/books:/calibre-library
      - $APPDIR/books/custom-files:/custom-cont-init.d:ro
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - DOCKER_MODS=lscr.io/linuxserver/mods:universal-calibre-v7.16.0
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.books.entrypoints=https
      - traefik.http.routers.books.rule=Host(`books.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.books.middlewares=auth
      # HTTP Services
      - traefik.http.routers.books.service=books
      - traefik.http.services.books.loadbalancer.server.port=8083
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# SYSTEM MANAGEMENT/MONITORING
  # Dockhand - full stack management, log viewer
  dockhand:
    image: fnsys/dockhand:latest
    container_name: dockhand
    restart: unless-stopped
    networks:
      mediaserver:
    ports:
      - 3336:3000
    volumes:
      - $APPDIR/dockhand:/app/data:rw
      - $APPDIR:/compose
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - HOST_DATA_DIR=$APPDIR/dockhand
      - SKIP_DF_COLLECTION=true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.dockhand.entrypoints=https
      - traefik.http.routers.dockhand.rule=Host(`dockhand.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.dockhand.middlewares=auth
      # HTTP Services
      - traefik.http.routers.dockhand.service=dockhand
      - traefik.http.services.dockhand.loadbalancer.server.port=3000
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  # Notifiarr - update ARR profiles
  notifiarr:
    image: golift/notifiarr:latest
    container_name: notifiarr
    hostname: notifiarr #must be set, can be anything
    restart: unless-stopped
    networks:
      mediaserver:
    ports:
      - 5454:5454
    volumes:
      - $APPDIR/notifiarr:/config
      - /var/run/utmp:/var/run/utmp
      - /etc/machine-id:/etc/machine-id
    environment:
      - USER=docker
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.notifiarr.entrypoints=https
      - traefik.http.routers.notifiarr.rule=Host(`notifiarr.$DOMAINNAME`)
      # Middlewares
      - traefik.http.routers.notifiarr.middlewares=auth
      # HTTP Services
      - traefik.http.routers.notifiarr.service=notifiarr
      - traefik.http.services.notifiarr.loadbalancer.server.port=5454
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO

  ############################# SECURITY/PASSWORD MANAGEMENT
  # Vaultwarden - Locally-hosted Bitwarden
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    networks:
      mediaserver:
    volumes:
      - $APPDIR/vaultwarden:/data
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      # HTTP Routers
      - traefik.http.routers.vaultwarden.entrypoints=https
      - traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.$DOMAINNAME`)
      # HTTP Services
      - traefik.http.routers.vaultwarden.service=vaultwarden
      - traefik.http.services.vaultwarden.loadbalancer.server.port=80
      ## Updating and notifications
      - org.hotio.pullio.notify=true
      - org.hotio.pullio.update=true
      - org.hotio.pullio.discord.webhook=$DISCORD
      - org.hotio.pullio.generic.webhook=$PULLIO
